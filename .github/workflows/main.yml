name: Build luci-app-dnscrypt-proxy2 for OpenWrt/ImmortalWrt

on:
  workflow_dispatch:
    inputs:
      firmware_type:
        description: "Firmware type"
        type: choice
        required: true
        default: "openwrt"
        options:
          - "openwrt"
          - "immortalwrt"
      openwrt_version:
        description: "OpenWrt/ImmortalWrt version (e.g., 24.10.4 or SNAPSHOT)"
        type: string
        required: true
        default: "24.10.4"
      openwrt_target:
        description: "Target (e.g., mediatek)"
        type: string
        required: true
        default: "mediatek"
      openwrt_subtarget:
        description: "Subtarget (e.g., filogic)"
        type: string
        required: true
        default: "filogic"
      openwrt_arch:
        description: "Architecture (e.g., aarch64_cortex-a53)"
        type: string
        required: true
        default: "aarch64_cortex-a53"

jobs:
  build-package:
    name: "Build LuCI for ${{ inputs.firmware_type }}: ${{ inputs.openwrt_version }} - ${{ inputs.openwrt_target }}/${{ inputs.openwrt_subtarget }}"
    runs-on: ubuntu-22.04
    defaults:
      run:
        shell: bash
        
    steps:
        # 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        submodules: true
        
    - name: Install dependencies
      run: |
        set -e -x
        sudo apt-get update
        sudo apt-get install -y build-essential gawk git python3 python3-setuptools rsync unzip wget xz-utils zstd
        
    - name: Extract package version from Makefile and set release tag
      id: pkg_version
      run: |
        set -e -x
        # –ò—â–µ–º –≤–µ—Ä—Å–∏—é –≤ Makefile LuCI-–ø–∞–∫–µ—Ç–∞
        PKG_VERSION=$(grep '^PKG_VERSION:=' Makefile | cut -d= -f2 | tr -d '[:space:]')
        if [ -z "$PKG_VERSION" ]; then
          echo "‚ùå Cannot find PKG_VERSION in Makefile"
          exit 1
        fi
        echo "PKG_VERSION=$PKG_VERSION" >> $GITHUB_ENV
        TAG_NAME="luci-app-dnscrypt-proxy2-${{ inputs.firmware_type }}-${{ inputs.openwrt_version }}-${{ inputs.openwrt_target }}-${{ inputs.openwrt_subtarget }}-${PKG_VERSION}"
        echo "tag_name=$TAG_NAME" >> $GITHUB_ENV
        echo "release_name=DNSCrypt Proxy LuCI Interface ${{ inputs.firmware_type }}-${{ inputs.openwrt_version }} for ${{ inputs.openwrt_arch }}" >> $GITHUB_ENV
        
    - name: Prepare SDK and Configure Build üõ†Ô∏è
      run: |
        set -e -x
        
        FIRMWARE_TYPE="${{ inputs.firmware_type }}"
        VERSION="${{ inputs.openwrt_version }}"
        TARGET="${{ inputs.openwrt_target }}"
        SUBTARGET="${{ inputs.openwrt_subtarget }}"
        
        # 1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ URL SDK
        if [ "$FIRMWARE_TYPE" = "openwrt" ]; then
          BASE_DOMAIN="downloads.openwrt.org"
          SDK_PATTERN="openwrt-sdk"
        else
          BASE_DOMAIN="downloads.immortalwrt.org"
          SDK_PATTERN="immortalwrt-sdk"
        fi
        
        if [ "$VERSION" = "SNAPSHOT" ]; then
          BASE_URL="https://${BASE_DOMAIN}/snapshots/targets/${TARGET}/${SUBTARGET}/"
        else
          BASE_URL="https://${BASE_DOMAIN}/releases/${VERSION}/targets/${TARGET}/${SUBTARGET}/"
        fi
        
        echo "üîç Searching SDK at: ${BASE_URL}"
        
        # 2. –ó–∞–≥—Ä—É–∑–∫–∞ –∏ —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∞ SDK
        sdk_url=$(curl -s "${BASE_URL}" | grep -oP "href=\"${SDK_PATTERN}[^\"]+\.tar\.(xz|zst|gz|bz2)\"" | sed -e 's/href="//' -e 's/"$//' | head -n1)
        
        if [[ -z "$sdk_url" ]]; then
          echo "‚ùå SDK file not found at ${BASE_URL}"
          exit 1
        fi
        
        curl -fsLO "${BASE_URL}${sdk_url}" || { echo "‚ùå Failed to download SDK"; exit 1; }
        file_name=$(basename "$sdk_url")
        
        tar -xf "$file_name" || { echo "‚ùå Failed to extract SDK"; exit 1; }
        rm -f *.tar.*
        
        SDK_DIR=$(find . -maxdepth 1 -type d -name "*${SDK_PATTERN}*" | head -1)
        mv "$SDK_DIR" sdk
        echo "‚úÖ SDK prepared in ./sdk/"
        
        # 3. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ minisign –∏ LuCI-–ø–∞–∫–µ—Ç–∞ –≤ SDK/package/
        echo "üì¶ Copying minisign and LuCI package to SDK/package/..."
        
        # –ö–æ–ø–∏—Ä—É–µ–º minisign (—É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–Ω –≤ ./minisign/)
        cp -r minisign sdk/package/
        
        # –ö–æ–ø–∏—Ä—É–µ–º LuCI-–ø–∞–∫–µ—Ç
        mkdir -p sdk/package/luci-app-dnscrypt-proxy2
        rsync -av --exclude 'sdk' --exclude 'minisign' --exclude '.git' --exclude '.github' . sdk/package/luci-app-dnscrypt-proxy2/
        echo "‚úÖ All required packages copied to SDK"
        
        # 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏–¥–æ–≤ —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏
        cd sdk
        
        MAX_ATTEMPTS=5
        for attempt in $(seq 1 $MAX_ATTEMPTS); do
            echo "üîÑ Updating feeds (Attempt $attempt/$MAX_ATTEMPTS)..."
            if ./scripts/feeds update -a; then
                echo "‚úÖ Feeds updated successfully."
                break
            else
                if [ $attempt -eq $MAX_ATTEMPTS ]; then
                    echo "‚ùå Failed to update feeds after $MAX_ATTEMPTS attempts."
                    exit 1
                fi
                echo "‚è≥ Waiting 15 seconds before retry..."
                sleep 15
            fi
        done
        
        echo "üì• Installing required packages..."
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º dnscrypt-proxy2 –∏–∑ feeds
        ./scripts/feeds install dnscrypt-proxy2 || { echo "‚ùå Failed to install dnscrypt-proxy2"; exit 1; }
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º libsodium (–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å minisign)
        ./scripts/feeds install libsodium || { echo "‚ùå Failed to install libsodium"; exit 1; }
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ LuCI
        ./scripts/feeds install luci-compat luci-lib-ip luci-lua-runtime || { echo "‚ùå Failed to install luci deps"; exit 1; }
        
        echo "‚úÖ Base dependencies installed"
        
        # üîß –í–ê–ñ–ù–û: –ü–∞—Ç—á–∏–º Makefile minisign –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–±–æ—Ä–∫–∏
        echo "üîß Patching minisign Makefile for static build..."
        MINISIGN_MAKEFILE="package/minisign/Makefile"
        
        if [ -f "$MINISIGN_MAKEFILE" ]; then
            echo "üìù Original minisign Makefile:"
            cat "$MINISIGN_MAKEFILE"
            echo ""
            
            # –ó–∞–º–µ–Ω—è–µ–º CMAKE_OPTIONS –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–±–æ—Ä–∫–∏
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º sed –¥–ª—è –∑–∞–º–µ–Ω—ã –≤–º–µ—Å—Ç–æ heredoc (–ø—Ä–æ—â–µ –¥–ª—è YAML)
            sed -i '/^CMAKE_OPTIONS/d' "$MINISIGN_MAKEFILE"
            sed -i '/^define Package\/minisign\/install/i\CMAKE_OPTIONS += -DSTATIC_LIBSODIUM=1 -DBUILD_STATIC_EXECUTABLES=1\n' "$MINISIGN_MAKEFILE"
            
            echo "‚úÖ minisign Makefile patched for static build"
            echo "üìù New minisign Makefile:"
            cat "$MINISIGN_MAKEFILE"
        else
            echo "‚ùå minisign Makefile not found at $MINISIGN_MAKEFILE"
            exit 1
        fi
        
        # –ó–∞–≥—Ä—É–∑–∫–∞ config.buildinfo
        echo "‚öôÔ∏è  Downloading base config..."
        curl -fsL "${BASE_URL}/config.buildinfo" > .config || { echo "‚ö†Ô∏è  config.buildinfo not found, using default"; }
        
        # –Ø–≤–Ω–æ –≤–∫–ª—é—á–∞–µ–º –ø–∞–∫–µ—Ç—ã
        echo "CONFIG_PACKAGE_minisign=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-dnscrypt-proxy2=y" >> .config
        
        # –í–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Minisign
        echo "CONFIG_PACKAGE_libsodium=y" >> .config
        echo "CONFIG_PACKAGE_libpthread=y" >> .config
        
        # üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –û—Ç–∫–ª—é—á–∞–µ–º minimal-—Å–±–æ—Ä–∫—É libsodium
        # –≠—Ç–æ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç —Ñ–ª–∞–≥ $(if $(CONFIG_LIBSODIUM_MINIMAL),--enable,--disable)-minimal
        echo "# CONFIG_LIBSODIUM_MINIMAL is not set" >> .config
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ minimal –æ—Ç–∫–ª—é—á—ë–Ω —è–≤–Ω–æ
        sed -i '/CONFIG_LIBSODIUM_MINIMAL=y/d' .config
        
        make defconfig
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        echo "üìã Checking libsodium configuration in .config:"
        grep -i "LIBSODIUM" .config || echo "‚ö†Ô∏è No LIBSODIUM config found"
        
        echo "‚úÖ Build configuration completed"

    - name: Build libsodium with full API
      run: |
        set -e -x
        cd sdk
        echo "üî® Building libsodium with full API..."
        make package/libsodium/compile V=s -j $(nproc) || { echo "‚ùå Failed to build libsodium"; exit 1; }
        
        # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ libsodium –≤ staging
        make package/libsodium/install V=s || { echo "‚ùå Failed to install libsodium"; exit 1; }
        echo "‚úÖ libsodium built and installed"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Å–æ–∑–¥–∞–Ω–∞
        echo "üì¶ Built libsodium files:"
        find staging_dir -name "*libsodium*" -ls || echo "‚ö†Ô∏è No libsodium files found"

    - name: Build Minisign Package (static)
      run: |
        set -e -x
        cd sdk
        echo "üî® Building minisign package (static)..."
        make package/minisign/compile V=s -j $(nproc) || { echo "‚ùå Failed to build minisign"; exit 1; }
        
        # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ minisign –≤ SDK (–≤–∞–∂–Ω–æ –¥–ª—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π)
        make package/minisign/install V=s || { echo "‚ùå Failed to install minisign"; exit 1; }
        echo "‚úÖ Minisign package built and installed"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–∞–∫–µ—Ç —Å–æ–∑–¥–∞–Ω
        echo "üì¶ Built minisign packages:"
        find bin -name "*minisign*.ipk" -ls || echo "‚ö†Ô∏è  No minisign IPK found yet"
        
    - name: Index packages (make minisign available)
      run: |
        set -e -x
        cd sdk
        echo "üìá Indexing packages..."
        make package/index V=s || { echo "‚ùå Failed to index packages"; exit 1; }
        echo "‚úÖ Packages indexed"
        
    - name: Compile LuCI Package
      run: |
        set -e -x
        cd sdk
        echo "üî® Compiling luci-app-dnscrypt-proxy2..."
        make package/luci-app-dnscrypt-proxy2/compile V=s -j $(nproc) || { echo "‚ùå Failed to compile LuCI package"; exit 1; }
        echo "‚úÖ LuCI package compiled successfully"
        
    - name: Prepare artifacts for release
      id: prepare_artifacts
      run: |
        set -e -x
        mkdir -p release
        
        echo "üì¶ Collecting built packages..."
        # –°–æ–±–∏—Ä–∞–µ–º minisign –∏ LuCI-–ø–∞–∫–µ—Ç
        find sdk/bin -type f -name "*luci-app-dnscrypt-proxy2*.ipk" -exec cp {} release/ \;
        find sdk/bin -type f -name "*minisign*.ipk" -exec cp {} release/ \;
        
        IPK_COUNT=$(find release -type f -name "*.ipk" | wc -l)
        if [ "$IPK_COUNT" -eq 0 ]; then
          echo "‚ùå No IPK files found! Build may have failed."
          echo "Looking for packages in sdk/bin:"
          find sdk/bin -name "*.ipk" -ls
          exit 1
        fi
        
        echo "‚úÖ Found $IPK_COUNT package(s):"
        ls -lh release/
        
    - name: Get current date for release notes
      id: get_date
      run: echo "date=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
      
    - name: Create Release and Upload Assets
      uses: softprops/action-gh-release@v2
      with:
        files: release/*
        tag_name: ${{ env.tag_name }}
        name: ${{ env.release_name }}
        body: |
          ## üì¶ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–±–æ—Ä–∫–∞ –ø–∞–∫–µ—Ç–æ–≤ DNSCrypt Proxy
          
          –≠—Ç–æ—Ç —Ä–µ–ª–∏–∑ —Å–æ–¥–µ—Ä–∂–∏—Ç **minisign** (—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–±–æ—Ä–∫–∞) –∏ **luci-app-dnscrypt-proxy2**, —Å–æ–±—Ä–∞–Ω–Ω—ã–µ –¥–ª—è —Ü–µ–ª–µ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã **${{ inputs.openwrt_arch }}**.
          
          ### ‚ö†Ô∏è –í–∞–∂–Ω–æ
          - –î–µ–º–æ–Ω **dnscrypt-proxy2** –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è OpenWrt/ImmortalWrt
          - –ü–∞–∫–µ—Ç **minisign** —Å–æ–±—Ä–∞–Ω —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏ —Å –ø–æ–ª–Ω—ã–º API libsodium
          - Minisign –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ —Å–ø–∏—Å–∫–∞–º–∏ —Ä–µ–∑–æ–ª–≤–µ—Ä–æ–≤
          
          ### üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–±–æ—Ä–∫–µ
          - **–î–∞—Ç–∞ —Å–±–æ—Ä–∫–∏:** ${{ steps.get_date.outputs.date }}
          - **Firmware:** ${{ inputs.firmware_type }} ${{ inputs.openwrt_version }}
          - **Target:** ${{ inputs.openwrt_target }}/${{ inputs.openwrt_subtarget }}
          - **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** ${{ inputs.openwrt_arch }}
          - **–í–µ—Ä—Å–∏—è –ø–∞–∫–µ—Ç–∞:** ${{ env.PKG_VERSION }}
          - **–¢–∏–ø —Å–±–æ—Ä–∫–∏:** –°—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è (static libsodium)
          
          ### üì• –£—Å—Ç–∞–Ω–æ–≤–∫–∞
          ```bash
          # –°–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ minisign
          opkg install minisign_*.ipk
          
          # –ó–∞—Ç–µ–º —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ LuCI-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
          opkg install luci-app-dnscrypt-proxy2_*.ipk
          ```
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
