name: Build luci-app-dnscrypt-proxy2 for OpenWrt/ImmortalWrt

on:
  workflow_dispatch:
    inputs:
      firmware_type:
        description: "Firmware type"
        type: choice
        required: true
        default: "openwrt"
        options:
          - "openwrt"
          - "immortalwrt"
      openwrt_version:
        description: "OpenWrt/ImmortalWrt version (e.g., 24.10.4 or SNAPSHOT)"
        type: string
        required: true
        default: "24.10.4"
      openwrt_target:
        description: "Target (e.g., mediatek)"
        type: string
        required: true
        default: "mediatek"
      openwrt_subtarget:
        description: "Subtarget (e.g., filogic)"
        type: string
        required: true
        default: "filogic"
      openwrt_arch:
        description: "Architecture (e.g., aarch64_cortex-a53)"
        type: string
        required: true
        default: "aarch64_cortex-a53"

jobs:
  build-package:
    name: "Build LuCI for ${{ inputs.firmware_type }}: ${{ inputs.openwrt_version }} - ${{ inputs.openwrt_target }}/${{ inputs.openwrt_subtarget }}"
    runs-on: ubuntu-22.04
    defaults:
      run:
        shell: bash
        
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
        
    - name: Install dependencies
      run: |
        set -e -x
        sudo apt-get update
        sudo apt-get install -y build-essential gawk git python3 python3-setuptools rsync unzip wget xz-utils zstd
        
    - name: Extract package version from Makefile and set release tag
      id: pkg_version
      run: |
        set -e -x
        PKG_VERSION=$(grep '^PKG_VERSION:=' Makefile | cut -d= -f2 | tr -d '[:space:]')
        if [ -z "$PKG_VERSION" ]; then
          echo "âŒ Cannot find PKG_VERSION in Makefile"
          exit 1
        fi
        echo "PKG_VERSION=$PKG_VERSION" >> $GITHUB_ENV
        
        BUILD_DATE=$(date +'%Y%m%d-%H%M%S')
        TAG_NAME="v${PKG_VERSION}-${{ inputs.firmware_type }}-${{ inputs.openwrt_version }}-${{ inputs.openwrt_target }}-${{ inputs.openwrt_subtarget }}-${BUILD_DATE}"
        echo "tag_name=$TAG_NAME" >> $GITHUB_ENV
        echo "release_name=DNSCrypt Proxy LuCI v${PKG_VERSION} - ${{ inputs.firmware_type }} ${{ inputs.openwrt_version }} (${{ inputs.openwrt_arch }})" >> $GITHUB_ENV
        
    - name: Prepare SDK and Configure Build ðŸ› ï¸
      run: |
        set -e -x
        
        FIRMWARE_TYPE="${{ inputs.firmware_type }}"
        VERSION="${{ inputs.openwrt_version }}"
        TARGET="${{ inputs.openwrt_target }}"
        SUBTARGET="${{ inputs.openwrt_subtarget }}"
        
        # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ URL SDK
        if [ "$FIRMWARE_TYPE" = "openwrt" ]; then
          BASE_DOMAIN="downloads.openwrt.org"
          SDK_PATTERN="openwrt-sdk"
        else
          BASE_DOMAIN="downloads.immortalwrt.org"
          SDK_PATTERN="immortalwrt-sdk"
        fi
        
        if [ "$VERSION" = "SNAPSHOT" ]; then
          BASE_URL="https://${BASE_DOMAIN}/snapshots/targets/${TARGET}/${SUBTARGET}/"
        else
          BASE_URL="https://${BASE_DOMAIN}/releases/${VERSION}/targets/${TARGET}/${SUBTARGET}/"
        fi
        
        echo "ðŸ” Searching SDK at: ${BASE_URL}"
        
        # Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð¸ Ñ€Ð°ÑÐ¿Ð°ÐºÐ¾Ð²ÐºÐ° SDK
        sdk_url=$(curl -s "${BASE_URL}" | grep -oP "href=\"${SDK_PATTERN}[^\"]+\.tar\.(xz|zst|gz|bz2)\"" | sed -e 's/href="//' -e 's/"$//' | head -n1)
        
        if [[ -z "$sdk_url" ]]; then
          echo "âŒ SDK file not found at ${BASE_URL}"
          exit 1
        fi
        
        curl -fsLO "${BASE_URL}${sdk_url}" || { echo "âŒ Failed to download SDK"; exit 1; }
        file_name=$(basename "$sdk_url")
        
        tar -xf "$file_name" || { echo "âŒ Failed to extract SDK"; exit 1; }
        rm -f *.tar.*
        
        SDK_DIR=$(find . -maxdepth 1 -type d -name "*${SDK_PATTERN}*" | head -1)
        mv "$SDK_DIR" sdk
        echo "âœ… SDK prepared in ./sdk/"
        
        # ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ð°ÐºÐµÑ‚Ð¾Ð² Ð² SDK
        echo "ðŸ“¦ Copying packages to SDK/package/..."
        
        # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ minisign
        cp -r minisign sdk/package/
        
        # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ LuCI-Ð¿Ð°ÐºÐµÑ‚
        mkdir -p sdk/package/luci-app-dnscrypt-proxy2
        rsync -av --exclude 'sdk' --exclude 'minisign' --exclude '.git' --exclude '.github' . sdk/package/luci-app-dnscrypt-proxy2/
        echo "âœ… All required packages copied to SDK"
        
        # ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ„Ð¸Ð´Ð¾Ð²
        cd sdk
        
        MAX_ATTEMPTS=5
        for attempt in $(seq 1 $MAX_ATTEMPTS); do
            echo "ðŸ”„ Updating feeds (Attempt $attempt/$MAX_ATTEMPTS)..."
            if ./scripts/feeds update -a; then
                echo "âœ… Feeds updated successfully."
                break
            else
                if [ $attempt -eq $MAX_ATTEMPTS ]; then
                    echo "âŒ Failed to update feeds after $MAX_ATTEMPTS attempts."
                    exit 1
                fi
                echo "â³ Waiting 15 seconds before retry..."
                sleep 15
            fi
        done
        
        echo "ðŸ“¥ Installing required packages..."
        
        # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
        ./scripts/feeds install dnscrypt-proxy2 || { echo "âŒ Failed to install dnscrypt-proxy2"; exit 1; }
        ./scripts/feeds install libsodium || { echo "âŒ Failed to install libsodium"; exit 1; }
        ./scripts/feeds install luci-base luci-lib-jsonc || { echo "âŒ Failed to install luci deps"; exit 1; }
        
        echo "âœ… Base dependencies installed"
        
        # Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° config.buildinfo
        echo "âš™ï¸  Downloading base config..."
        curl -fsL "${BASE_URL}/config.buildinfo" > .config || { echo "âš ï¸  config.buildinfo not found, using default"; }
        
        # Ð¯Ð²Ð½Ð¾ Ð²ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð¿Ð°ÐºÐµÑ‚Ñ‹
        echo "CONFIG_PACKAGE_minisign=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-dnscrypt-proxy2=y" >> .config
        echo "CONFIG_PACKAGE_libsodium=y" >> .config
        echo "CONFIG_PACKAGE_libpthread=y" >> .config
        
        # ÐžÑ‚ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ minimal-ÑÐ±Ð¾Ñ€ÐºÑƒ libsodium
        echo "# CONFIG_LIBSODIUM_MINIMAL is not set" >> .config
        sed -i '/CONFIG_LIBSODIUM_MINIMAL=y/d' .config
        
        make defconfig
        
        # ÐžÑ‚ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð¿Ð¾Ð´Ð¿Ð¸ÑÑŒ Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²
        echo "ðŸ”§ Disabling package signing for CI build..."
        sed -i 's/CONFIG_SIGNED_PACKAGES=y/# CONFIG_SIGNED_PACKAGES is not set/' .config
        echo "CONFIG_SIGNED_PACKAGES=n" >> .config
        make defconfig
        
        echo "âœ… Build configuration completed"

    - name: Build libsodium with full API
      run: |
        set -e -x
        cd sdk
        echo "ðŸ”¨ Building libsodium with full API..."
        make package/libsodium/compile V=s -j $(nproc) || { echo "âŒ Failed to build libsodium"; exit 1; }
        echo "âœ… libsodium compiled successfully"

    - name: Build Minisign Package
      run: |
        set -e -x
        cd sdk
        echo "ðŸ”¨ Building minisign package..."
        make package/minisign/compile V=s -j $(nproc) || { echo "âŒ Failed to build minisign"; exit 1; }
        echo "âœ… Minisign package built successfully"
        
    - name: Index packages
      run: |
        set -e -x
        cd sdk
        echo "ðŸ“‡ Indexing packages..."
        
        make package/index CONFIG_SIGNED_PACKAGES= V=s 2>&1 | grep -v "Cannot open file" || true
        
        if find bin/packages/*/base/Packages -type f 2>/dev/null | grep -q .; then
          echo "âœ… Packages indexed successfully"
        else
          echo "âš ï¸  Creating index manually..."
          for dir in bin/packages/*/base; do
            if [ -d "$dir" ]; then
              ( cd "$dir" && \
                ../../../../scripts/ipkg-make-index.sh . > Packages && \
                gzip -9nc Packages > Packages.gz
              ) || true
            fi
          done
        fi
        
        echo "âœ… Package indexing completed"
        
    - name: Compile LuCI Package
      run: |
        set -e -x
        cd sdk
        echo "ðŸ”¨ Compiling luci-app-dnscrypt-proxy2..."
        make package/luci-app-dnscrypt-proxy2/compile V=s -j $(nproc) || { echo "âŒ Failed to compile LuCI package"; exit 1; }
        echo "âœ… LuCI package compiled successfully"
        
    - name: Prepare artifacts for release
      id: prepare_artifacts
      run: |
        set -e -x
        mkdir -p release
        
        echo "ðŸ“¦ Collecting built packages..."
        find sdk/bin -type f -name "*luci-app-dnscrypt-proxy2*.ipk" -exec cp {} release/ \;
        find sdk/bin -type f -name "*minisign*.ipk" -exec cp {} release/ \;
        
        IPK_COUNT=$(find release -type f -name "*.ipk" | wc -l)
        if [ "$IPK_COUNT" -eq 0 ]; then
          echo "âŒ No IPK files found!"
          find sdk/bin -name "*.ipk" -ls
          exit 1
        fi
        
        echo "âœ… Found $IPK_COUNT package(s):"
        ls -lh release/
        
    - name: Get current date for release notes
      id: get_date
      run: echo "date=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
      
    - name: Create Release and Upload Assets
      run: |
        set -e -x
        
        echo "ðŸ“¦ Files to upload:"
        ls -lh release/
        
        cat > release_notes.md << 'EOF'
        ## ðŸ“¦ DNSCrypt Proxy LuCI - Refactored Version
        
        This release contains **luci-app-dnscrypt-proxy2** (refactored, TOML-based) and **minisign** packages for **${{ inputs.openwrt_arch }}** architecture.
        
        ### âœ¨ New Features
        - âœ… Direct TOML configuration editing
        - âœ… Full ODoH (Oblivious DoH) support
        - âœ… Modern LuCI interface
        - âœ… No UCI complexity
        
        ### âš ï¸ Important
        - **dnscrypt-proxy2** daemon must be installed from official OpenWrt/ImmortalWrt repository
        - **minisign** is built statically with full libsodium API
        - This is a **refactored version** - not compatible with old UCI-based configs
        
        ### ðŸ“‹ Build Information
        - **Build Date:** ${{ steps.get_date.outputs.date }}
        - **Firmware:** ${{ inputs.firmware_type }} ${{ inputs.openwrt_version }}
        - **Target:** ${{ inputs.openwrt_target }}/${{ inputs.openwrt_subtarget }}
        - **Architecture:** ${{ inputs.openwrt_arch }}
        - **Package Version:** ${{ env.PKG_VERSION }}
        - **Release Tag:** ${{ env.tag_name }}
        
        ### ðŸ“¥ Installation
        ```bash
        # Install dnscrypt-proxy2 first (from official repo)
        opkg update
        opkg install dnscrypt-proxy2
        
        # Install minisign
        opkg install minisign_*_${{ inputs.openwrt_arch }}.ipk
        
        # Install LuCI app
        opkg install luci-app-dnscrypt-proxy2_*.ipk
        ```
        
        ### ðŸ”„ Migration from Old Version
        See [MIGRATION_GUIDE.md](https://github.com/kozhini/luci-app-dnscrypt-proxy2/blob/main/MIGRATION_GUIDE.md)
        
        ### ðŸ“¦ Package Contents
        EOF
        
        echo '```' >> release_notes.md
        ls -lh release/ >> release_notes.md
        echo '```' >> release_notes.md
        
        # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ Ñ€ÐµÐ»Ð¸Ð· ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ
        gh release delete "${{ env.tag_name }}" -y 2>/dev/null || echo "No existing release to delete"
        
        # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð½Ð¾Ð²Ñ‹Ð¹ Ñ€ÐµÐ»Ð¸Ð·
        gh release create "${{ env.tag_name }}" \
          --title "${{ env.release_name }}" \
          --notes-file release_notes.md \
          --latest \
          release/*
        
        echo "âœ… Release created successfully!"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
